<Tool Name="CashFlowAllocationBondDueModel">
   <Actions>
    <Action ActionCode="OpeningBalance_#level#_#Id#" ActionDisplayName="#{ShortName}#期初本金余额" FunctionName="RunManagedMethodByPath" SequenceNo="29">
      <Parameter Name="IsCashFlowDisplay" SessionParameterName="" Value="true" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="InputType" SessionParameterName="" Value="Calculated" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="ActionType" SessionParameterName="" Value="CashFlow" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="AssemblyPath" SessionParameterName="" Value="" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="TypeName" SessionParameterName="" Value="EquationProvider.CashFlowEquationProvider" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="MethodName" SessionParameterName="" Value="EC_OpeningBalance_#level#_#Id#" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="CurrentPosition" SessionParameterName="CurrentPosition" Value="0" DataType="Int16" Usage="" IsConfigurable="false" />
      <Parameter Name="CashFlowName" SessionParameterName="" Value="OpeningBalance_#level#_#Id#" DataType="String" Usage="" IsConfigurable="false" />
    </Action>
    <Action ActionCode="NumberOfNotes_#level#_#Id#" ActionDisplayName="#{ShortName}#发行份数" FunctionName="RunManagedMethodByPath" SequenceNo="30">
      <Parameter Name="IsCashFlowDisplay" SessionParameterName="" Value="true" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="InputType" SessionParameterName="" Value="Calculated" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="ActionType" SessionParameterName="" Value="CashFlow" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="AssemblyPath" SessionParameterName="" Value="" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="TypeName" SessionParameterName="" Value="EquationProvider.CashFlowEquationProvider" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="MethodName" SessionParameterName="" Value="EC_NumberOfNotes_#level#_#Id#" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="CurrentPosition" SessionParameterName="CurrentPosition" Value="0" DataType="Int16" Usage="" IsConfigurable="false" />
      <Parameter Name="CashFlowName" SessionParameterName="" Value="NumberOfNotes_#level#_#Id#" DataType="String" Usage="" IsConfigurable="false" />
    </Action>
    <Action ActionCode="StatedAmountPerNotePriorPayment_#level#_#Id#" ActionDisplayName="#{ShortName}#分配前每份金额" FunctionName="RunManagedMethodByPath" SequenceNo="31">
      <Parameter Name="IsCashFlowDisplay" SessionParameterName="" Value="true" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="InputType" SessionParameterName="" Value="Calculated" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="ActionType" SessionParameterName="" Value="CashFlow" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="AssemblyPath" SessionParameterName="" Value="" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="TypeName" SessionParameterName="" Value="EquationProvider.CashFlowEquationProvider" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="MethodName" SessionParameterName="" Value="EC_StatedAmountPerNotePriorPayment_#level#_#Id#" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="CurrentPosition" SessionParameterName="CurrentPosition" Value="0" DataType="Int16" Usage="" IsConfigurable="false" />
      <Parameter Name="CashFlowName" SessionParameterName="" Value="StatedAmountPerNotePriorPayment_#level#_#Id#" DataType="String" Usage="" IsConfigurable="false" />
    </Action>
    <Action ActionCode="Interest_Denominator_#level#_#Id#" ActionDisplayName="#{ShortName}#全年计息基数" FunctionName="RunManagedMethodByPath" SequenceNo="32">
      <Parameter Name="IsDirectInput" SessionParameterName="" Value="true" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="IsCashFlowDisplay" SessionParameterName="" Value="false" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="InputType" SessionParameterName="" Value="Calculated" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="ActionType" SessionParameterName="" Value="CashFlow" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="AssemblyPath" SessionParameterName="" Value="" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="TypeName" SessionParameterName="" Value="EquationProvider.CashFlowEquationProvider" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="MethodName" SessionParameterName="" Value="" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="CurrentPosition" SessionParameterName="CurrentPosition" Value="0" DataType="Int16" Usage="" IsConfigurable="false" />
      <Parameter Name="CashFlowName" SessionParameterName="" Value="Interest_Denominator_#level#_#Id#" DataType="String" Usage="" IsConfigurable="false" />
    </Action>
    <Action ActionCode="Interest_Numerator_#level#_#Id#" ActionDisplayName="#{ShortName}#当期计息天数" FunctionName="RunManagedMethodByPath" SequenceNo="32">
      <Parameter Name="IsDirectInput" SessionParameterName="" Value="true" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="IsCashFlowDisplay" SessionParameterName="" Value="false" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="InputType" SessionParameterName="" Value="Calculated" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="ActionType" SessionParameterName="" Value="CashFlow" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="AssemblyPath" SessionParameterName="" Value="" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="TypeName" SessionParameterName="" Value="EquationProvider.CashFlowEquationProvider" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="MethodName" SessionParameterName="" Value="" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="CurrentPosition" SessionParameterName="CurrentPosition" Value="0" DataType="Int16" Usage="" IsConfigurable="false" />
      <Parameter Name="CashFlowName" SessionParameterName="" Value="Interest_Numerator_#level#_#Id#" DataType="String" Usage="" IsConfigurable="false" />
    </Action>
	  <Action ActionCode="Principal_Scheduled_#level#_#Id#" ActionDisplayName="#{ShortName}#当期计划还本" FunctionName="RunManagedMethodByPath" SequenceNo="34">
      <Parameter Name="IsDirectInput" SessionParameterName="" Value="true" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="IsCashFlowDisplay" SessionParameterName="" Value="true" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="InputType" SessionParameterName="" Value="Calculated" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="ActionType" SessionParameterName="" Value="CashFlow" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="AssemblyPath" SessionParameterName="" Value="" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="TypeName" SessionParameterName="" Value="EquationProvider.CashFlowEquationProvider" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="MethodName" SessionParameterName="" Value="" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="CurrentPosition" SessionParameterName="CurrentPosition" Value="0" DataType="Int16" Usage="" IsConfigurable="false" />
      <Parameter Name="CashFlowName" SessionParameterName="" Value="Principal_Scheduled_#level#_#Id#" DataType="String" Usage="" IsConfigurable="false" />
    </Action>
	 <Action ActionCode="Principal_Due_#level#_#Id#" ActionDisplayName="#{ShortName}#当期应付本金" FunctionName="RunManagedMethodByPath" SequenceNo="33">
      <Parameter Name="IsCashFlowDisplay" SessionParameterName="" Value="true" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="InputType" SessionParameterName="" Value="Calculated" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="ActionType" SessionParameterName="" Value="CashFlow" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="AssemblyPath" SessionParameterName="" Value="" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="TypeName" SessionParameterName="" Value="EquationProvider.CashFlowEquationProvider" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="MethodName" SessionParameterName="" Value="EC_AllocationAmount_#level#_#Id#" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="CurrentPosition" SessionParameterName="CurrentPosition" Value="0" DataType="Int16" Usage="" IsConfigurable="false" />
      <Parameter Name="CashFlowName" SessionParameterName="" Value="Principal_Due_#level#_#Id#" DataType="String" Usage="" IsConfigurable="false" />
    </Action>
    <Action ActionCode="Interest_Due_#level#_#Id#" ActionDisplayName="#{ShortName}#当期应付利息" FunctionName="RunManagedMethodByPath" SequenceNo="32">
      <Parameter Name="IsCashFlowDisplay" SessionParameterName="" Value="true" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="InputType" SessionParameterName="" Value="Calculated" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="ActionType" SessionParameterName="" Value="CashFlow" DataType="String" Usage="CashFlow" IsConfigurable="false" />
      <Parameter Name="AssemblyPath" SessionParameterName="" Value="" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="TypeName" SessionParameterName="" Value="EquationProvider.CashFlowEquationProvider" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="MethodName" SessionParameterName="" Value="EC_CurrentPeriodInterest_#level#_#Id#" DataType="String" Usage="Task" IsConfigurable="false" />
      <Parameter Name="CurrentPosition" SessionParameterName="CurrentPosition" Value="0" DataType="Int16" Usage="" IsConfigurable="false" />
      <Parameter Name="CashFlowName" SessionParameterName="" Value="Interest_Due_#level#_#Id#" DataType="String" Usage="" IsConfigurable="false" />
    </Action>
    <Action ActionCode="Interest_Paid_#level#_#Id#" ActionDisplayName="#{ShortName}#当期利息分配" FunctionName="RunManagedMethodByPath" SequenceNo="35">
      <Parameter Name="IsCashFlowDisplay" SessionParameterName="" Value="true" DataType="String" Usage="CashFlow" />
      <Parameter Name="InputType" SessionParameterName="" Value="Calculated" DataType="String" Usage="CashFlow" />
      <Parameter Name="ActionType" SessionParameterName="" Value="CashFlow" DataType="String" Usage="CashFlow" />
      <Parameter Name="AssemblyPath" SessionParameterName="" Value="" DataType="String" Usage="Task" />
      <Parameter Name="TypeName" SessionParameterName="" Value="AddIn.CashflowScript.GenericBondWaterfallPlus" DataType="String" Usage="Task" />
      <Parameter Name="MethodName" SessionParameterName="" Value="CreateCashFlow" DataType="String" Usage="Task" />
      <Parameter Usage="" DataType="Int16" Value="0" SessionParameterName="CurrentPosition" Name="CurrentPosition" />
      <Parameter Usage="" DataType="String" Value="Interest_Paid_#level#_#Id#" SessionParameterName="" Name="CashFlowName" />
    </Action>
    <Action ActionCode="Principal_Paid_#level#_#Id#" ActionDisplayName="#{ShortName}#当期本金分配" FunctionName="RunManagedMethodByPath" SequenceNo="36">
      <Parameter Name="IsCashFlowDisplay" SessionParameterName="" Value="true" DataType="String" Usage="CashFlow" />
      <Parameter Name="InputType" SessionParameterName="" Value="Calculated" DataType="String" Usage="CashFlow" />
      <Parameter Name="ActionType" SessionParameterName="" Value="CashFlow" DataType="String" Usage="CashFlow" />
      <Parameter Name="AssemblyPath" SessionParameterName="" Value="" DataType="String" Usage="Task" />
      <Parameter Name="TypeName" SessionParameterName="" Value="AddIn.CashflowScript.GenericBondWaterfallPlus" DataType="String" Usage="Task" />
      <Parameter Name="MethodName" SessionParameterName="" Value="CreateCashFlow" DataType="String" Usage="Task" />
      <Parameter Usage="" DataType="Int16" Value="0" SessionParameterName="CurrentPosition" Name="CurrentPosition" />
      <Parameter Usage="" DataType="String" Value="Principal_Paid_#level#_#Id#" SessionParameterName="" Name="CashFlowName" />
    </Action>
    
	 </Actions>
     <Methods>
	    <main>
      <Parameters>
        <Parameter Name="NumberOfNotes" SessionParameterName="NumberOfNotes_#level#_#Id#" Value="10" DataType="double" Usage="CashFlow" />
        <Parameter Name="Precision" SessionParameterName="InterestPrecision" Value="" DataType="double" Usage="CashFlow" />
		<Parameter Name="InterestInitialAmount" SessionParameterName="InterestInitialAmount_#level#_#Id#" Value="10" DataType="double" Usage="CashFlow" />
		<Parameter Name="InterestRoundingRule" SessionParameterName="InterestRoundingRule_#level#_#Id#" Value="10" DataType="double" Usage="CashFlow" />
        <Parameter Name="StatedAmountPerNotePriorPayment" SessionParameterName="" Value="" DataType="double" Usage="CashFlow">
          <Field Name="StatedAmountPerNotePriorPayment_#level#_#Id#">
            <Position>CurrentPosition</Position>
          </Field>
        </Parameter>
        <Parameter Name="AnnualDays" SessionParameterName="" Value="" DataType="double" Usage="CashFlow">
          <Field Name="Interest_Denominator_#level#_#Id#">
            <Position>CurrentPosition</Position>
          </Field>
        </Parameter>
		<Parameter Name="PreInterestLeftover" SessionParameterName="" Value="" DataType="double" Usage="CashFlow">
          <Field Name="InterestLeftover_#level#_#Id#">
            <Position>Math.Max(CurrentPosition-1,0)</Position>
          </Field>
        </Parameter>
      </Parameters>
      <Query name="EC_CurrentPeriodInterest_#level#_#Id#">
         double InterestLeftover=(CurrentPosition==0? InterestInitialAmount:PreInterestLeftover);
		 int i=0;
         double InterestTotal= 0.00;
         while (true)
          {
           String RateName= "BaseNoteMargin_#level#_#Id#_"+i.ToString();
           String DaysName= "InterestDays_#level#_#Id#_"+i.ToString();
           if ((!sContextArray.Keys.Contains(RateName)) || (!sContextArray.Keys.Contains(DaysName)))
           break;
           double Rate =double.Parse(sContextArray[RateName][CurrentPosition.ToString()]); 
           double Days =double.Parse(sContextArray[DaysName][CurrentPosition.ToString()]);
		   InterestTotal+=StatedAmountPerNotePriorPayment*NumberOfNotes*Rate*Days/AnnualDays;
           i++;
          } 
		  
		  if(InterestRoundingRule==0)
		  {
		      return Math.Round(InterestTotal,2,MidpointRounding.AwayFromZero)+InterestLeftover;
		  }
		  else if(InterestRoundingRule==1)
		  {
		     return RoundUp(InterestTotal,2)+InterestLeftover;
		  }
		  else
		  {
		     return RoundDown(InterestTotal,2)+InterestLeftover;
		  }
      </Query>
      <Presentation />
    </main>
	   <main>
      <Parameters>
        <Parameter Name="LastScheduledPeriod" SessionParameterName="LastScheduledPeriod_#level#_#Id#" Value="" DataType="double" Usage="CashFlow" />
        <Parameter Name="OpeningBalance" SessionParameterName="" Value="" DataType="double" Usage="CashFlow">
          <Field Name="OpeningBalance_#level#_#Id#">
            <Position>CurrentPosition</Position>
          </Field>
        </Parameter>
        <Parameter Name="Principal_Scheduled" SessionParameterName="" Value="" DataType="double" Usage="CashFlow">
          <Field Name="Principal_Scheduled_#level#_#Id#">
            <Position>CurrentPosition</Position>
          </Field>
        </Parameter>
		<Parameter Name="PrincipalToBePaid" SessionParameterName="" Value="" DataType="double" Usage="CashFlow">
          <Field Name="PrincipalToBePaid_#level#_#Id#">
            <Position>CurrentPosition</Position>
          </Field>
        </Parameter>
      </Parameters>
      <Query name="EC_AllocationAmount_#level#_#Id#">
	    PrincipalToBePaid =double.Parse(sContextArray["PrincipalToBePaid_#level#_#Id#"][CurrentPosition.ToString()]); 
		if(PrincipalToBePaid >0)
		{
        if (Principal_Scheduled == 0 || CurrentPosition + 1>= (int)LastScheduledPeriod)
        {
        return OpeningBalance;
        }
        else
        {
        return Math.Min(Principal_Scheduled, OpeningBalance);
        }
		}
		else
		{
		return 0.00;
		}
      </Query>
      <Presentation />
    </main>
	  <main>
      <Parameters>
        <Parameter Name="InitialInvestedAmount" SessionParameterName="InitialInvestedAmount_#level#_#Id#" Value="" DataType="double" Usage="CashFlow" />
        <Parameter Name="PreClosingBalance" SessionParameterName="" Value="" DataType="double" Usage="CashFlow">
          <Field Name="ClosingBalance_#level#_#Id#">
            <Position>Math.Max(CurrentPosition-1,0)</Position>
          </Field>
        </Parameter>
      </Parameters>
      <Query name="EC_OpeningBalance_#level#_#Id#">
        if (CurrentPosition == 0 )
        {
        return InitialInvestedAmount;
        }
        else
        {
        return PreClosingBalance;
        };
      </Query>
      <Presentation />
    </main>
	  <main>
      <Parameters>
        <Parameter Name="NumberOfNotes" SessionParameterName="NumberOfNotes_#level#_#Id#" Value="" DataType="double" Usage="CashFlow" />
      </Parameters>
      <Query name="EC_NumberOfNotes_#level#_#Id#">
        return NumberOfNotes;
      </Query>
      <Presentation />
    </main>
	  <main>
      <Parameters>
        <Parameter Name="NumberOfNotes" SessionParameterName="NumberOfNotes_#level#_#Id#" Value="" DataType="double" Usage="CashFlow" />
        <Parameter Name="OpeningBalance" SessionParameterName="" Value="" DataType="double" Usage="CashFlow">
          <Field Name="OpeningBalance_#level#_#Id#">
            <Position>CurrentPosition</Position>
          </Field>
        </Parameter>
      </Parameters>
      <Query name="EC_StatedAmountPerNotePriorPayment_#level#_#Id#">
        return OpeningBalance / NumberOfNotes;
      </Query>
      <Presentation />
    </main>
	  </Methods>
</Tool>